<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh toán | Bookstore</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans">
    <div class="max-w-4xl mx-auto p-6 bg-white mt-8 rounded shadow">
      <h1 class="text-3xl font-bold mb-6">Xác nhận đơn hàng</h1>

      <!-- Danh sách sách -->
      <div id="checkout-items" class="space-y-4 mb-6"></div>

      <!-- Tổng tiền -->
      <div class="text-right text-xl font-semibold mb-6">
        Tổng cộng: <span id="total-amount">0đ</span>
      </div>

      <!-- Thông tin người nhận -->
      <div class="mb-6 space-y-4">
        <input
          type="text"
          id="customer-name"
          placeholder="Họ tên người nhận"
          class="w-full border px-4 py-2 rounded"
          required
        />
        <input
          type="text"
          id="customer-phone"
          placeholder="Số điện thoại"
          class="w-full border px-4 py-2 rounded"
          required
        />
        <input
          type="text"
          id="customer-address"
          placeholder="Địa chỉ giao hàng"
          class="w-full border px-4 py-2 rounded"
          required
        />
      </div>

      <!-- Mã giảm giá -->
      <div class="flex gap-4 mb-6">
        <select id="discount-code" class="border px-4 py-2 rounded w-full">
          <option value="">-- Chọn mã giảm giá --</option>
          <option value="LOVEBOOK">LOVEBOOK - Giảm 15.000đ</option>
          <option value="USAGI">USAGI - Giảm 15.000đ</option>
          <option value="CHIIKAWA">CHIIKAWA - Giảm 15.000đ</option>
          <option value="HACHIWARE">HACHIWARE - Giảm 15.000đ</option>
        </select>
        <button
          onclick="applyDiscount()"
          class="bg-black text-white px-4 py-2 rounded"
        >
          Áp dụng
        </button>
      </div>

      <!-- Chọn phương thức thanh toán -->
      <div class="mb-6">
        <label class="block mb-2 font-medium"
          >Chọn phương thức thanh toán:</label
        >
        <div class="space-y-2" id="payment-methods">
          <label
            ><input type="radio" name="payment" value="cod" checked /> Thanh
            toán khi nhận hàng</label
          ><br />
          <label
            ><input type="radio" name="payment" value="credit" /> Thẻ tín
            dụng</label
          ><br />
          <label
            ><input type="radio" name="payment" value="bank" /> Thẻ ngân
            hàng</label
          ><br />
          <label
            ><input type="radio" name="payment" value="transfer" /> Chuyển
            khoản</label
          >
        </div>
      </div>

      <!-- Thông tin chi tiết phương thức thanh toán -->
      <div id="payment-details" class="mb-6 hidden"></div>
        <!-- nội dung động -->
      </div>

      <!-- Nút xác nhận và quay lại-->
      <div>
        <span>
          <button
            onclick="goBack()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded text-lg font-medium"
          >
            ⬅ Quay lại
          </button>
        </span>
        <span class="float-right">
          <button
            onclick="submitOrder()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded text-lg font-medium"
          >
            Đặt hàng
          </button>
        </span>
      </div>
    </div>

    <script>
      // lấy user id từ sessionStorage
      const userId = sessionStorage.getItem("UserID");
      document.addEventListener("DOMContentLoaded", function () {
        loadCheckoutItems();
      });


        // Gọi khi trang tải xong
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('input[name="payment"]').forEach((input) => {
          input.addEventListener("change", updatePaymentFields);
        });
        updatePaymentFields(); // chạy lần đầu
      });
      

      function updatePaymentFields() {
        const selected = document.querySelector('input[name="payment"]:checked').value;
        const container = document.getElementById("payment-details");
        container.innerHTML = "";
        container.classList.remove("hidden");

        if (selected === "credit" || selected === "bank") {
          container.innerHTML = `
            <input type="text" placeholder="Tên chủ thẻ" class="w-full border px-4 py-2 rounded mb-3" />
            <input type="text" placeholder="Số thẻ" class="w-full border px-4 py-2 rounded mb-3" />
            <input type="text" placeholder="Ngày hết hạn (MM/YY)" class="w-full border px-4 py-2 rounded mb-3" />
          `;
        } else if (selected === "transfer") {
          container.innerHTML = `
            <p class="text-sm mb-2 text-gray-700">Quét mã QR để chuyển khoản:</p>
            <img src="QR.jpg" alt="QR Code" class="w-40 h-40 object-contain" />
          `;
        } else {
          container.classList.add("hidden"); // COD thì ẩn luôn
        }
      }
      function loadCheckoutItems() {
        const checkoutItems =
          JSON.parse(sessionStorage.getItem("checkoutItems")) || [];
        console.log("Checkout Items:", checkoutItems); // Debug

        const container = document.getElementById("checkout-items");
        const totalAmountEl = document.getElementById("total-amount");
        container.innerHTML = "";

        if (checkoutItems.length === 0) {
          container.innerHTML = `<p class="text-gray-600">Không có sản phẩm nào trong đơn hàng.</p>`;
          totalAmountEl.textContent = "0đ";
          return;
        }

        let totalAmount = 0;

        checkoutItems.forEach((item) => {
          if (!item.title || !item.price || !item.quantity) {
            console.error("Lỗi dữ liệu sản phẩm:", item);
            return;
          }

          const itemTotal = item.price * item.quantity;
          totalAmount += itemTotal;

          const div = document.createElement("div");
          div.className =
            "flex justify-between items-center bg-gray-100 p-4 rounded";
          div.innerHTML = `
        <div>
          <p class="font-semibold">${item.title}</p>
          <p class="text-sm text-gray-500">${item.price.toFixed(2)} VND x ${
            item.quantity
          }</p>
        </div>
        <p class="text-lg font-semibold">${itemTotal.toFixed(2)} VND</p>
      `;

          container.appendChild(div);
        });

        totalAmountEl.textContent = `${totalAmount.toFixed(2)} VND`;
      }

      // Áp dụng mã giảm giá
      function applyDiscount() {
        const discountCode = document.getElementById("discount-code").value;
        const totalAmountEl = document.getElementById("total-amount");
        let totalAmount = parseFloat(
          totalAmountEl.innerText.replace(" VND", "")
        );

        const discountValues = {
          LOVEBOOK: 15000,
          USAGI: 15000,
          CHIIKAWA: 15000,
          HACHIWARE: 15000,
        };

        if (discountValues[discountCode]) {
          totalAmount -= discountValues[discountCode];
          totalAmountEl.innerText = `${Math.max(totalAmount, 0).toFixed(
            2
          )} VND`;
          alert("Mã giảm giá áp dụng thành công!");
        } else {
          alert("Mã giảm giá không hợp lệ!");
        }
      }

      const selectedPayment = document.querySelector(
        'input[name="payment"]:checked'
      ).value;
      const paymentDetails = document.getElementById("payment-details");
      const paymentMethods = document.querySelectorAll('input[name="payment"]');

      // Gửi đơn hàng
      function submitOrder() {
        const name = document.getElementById("customer-name").value.trim();
        const phone = document.getElementById("customer-phone").value.trim();
        const selectedPayment = document.querySelector('input[name="payment"]:checked').value;

        const address = document
          .getElementById("customer-address")
          .value.trim();
        const paymentMethod = document.querySelector(
          "input[name='payment']:checked"
        ).value; // Lấy phương thức thanh toán từ radio button
        const checkoutItems =
          JSON.parse(sessionStorage.getItem("checkoutItems")) || [];

        if (!name || !phone || !address) {
          alert("Vui lòng điền đầy đủ thông tin nhận hàng.");
          return;
        }

        if (checkoutItems.length === 0) {
          alert("Không có sản phẩm nào để đặt hàng.");
          return;
        }

        const orderData = {
          UserId: userId, // UserId của người dùng
          Address: address, // Địa chỉ
          paymentMethod: selectedPayment, // Phương thức thanh toán
          PaymentMethod: paymentMethod, // Phương thức thanh toán
          OrderItems: checkoutItems, // Danh sách sản phẩm trong đơn hàng
        };

        console.log("Đơn hàng:", orderData);

        // Gọi hàm placeOrder để xử lý việc gửi đơn hàng
        placeOrder(orderData);
      }

      async function placeOrder(orderData) {
        // Kiểm tra orderData trước khi lấy checkoutItems
        const checkoutItems = orderData.OrderItems;

        // Kiểm tra xem checkoutItems có dữ liệu hợp lệ không
        if (!Array.isArray(checkoutItems) || checkoutItems.length === 0) {
          alert("Không có sản phẩm trong đơn hàng.");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:5178/Order/CreateOrder",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(orderData),
            }
          );

          const data = await response.text(); // Lấy dữ liệu dưới dạng text để kiểm tra nội dung
          console.log("Order response:", data); // In nội dung phản hồi để xem chi tiết

          let parsedData = {};
          try {
            parsedData = JSON.parse(data);
          } catch (error) {
            console.error("Lỗi phân tích JSON:", error);
          }

          if (response.ok) {
            // chuyển sang trang success.html
            window.location.href = "success.html"; // Chuyển hướng đến trang thành công
            const orderID = parsedData.orderId; // Lấy orderId từ response
            await insertOrderItems(orderID, checkoutItems); // Gọi insertOrderItems với checkoutItems
          } else {
            alert(`Lỗi: ${parsedData.message || "Đã có lỗi xảy ra."}`);
          }
        } catch (error) {
          console.error("Lỗi thanh toán:", error);
          alert("Đã xảy ra lỗi khi thanh toán.");
        }
      }

      async function insertOrderItems(orderID, checkoutItems) {
        // Kiểm tra checkoutItems có phải là mảng không và có phần tử hay không
        if (!Array.isArray(checkoutItems) || checkoutItems.length === 0) {
          console.error("Không có sản phẩm trong đơn hàng.");
          alert("Không có sản phẩm trong đơn hàng.");
          return;
        }

        const orderItemData = checkoutItems.map((item) => ({
          OrderId: orderID,
          BookId: item.bookId,
          Quantity: item.quantity,
        }));
      }

      function goBack() {
        // Xóa giỏ hàng khỏi sessionStorage khi quay lại
        sessionStorage.removeItem("checkoutItems");

        // Chuyển hướng lại trang giỏ hàng
        window.location.href = "cart.html"; // Hoặc quay lại trang giỏ hàng của bạn
      }
    </script>
  </body>
</html>
