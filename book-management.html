<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-white text-gray-800 font-sans">
    <script src="include-header.js"></script>

    <main class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">Book Management System</h1>
        <button
          onclick="openAddModal()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2"
        >
          <span>➕</span> Add Book
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200">
          <thead class="bg-gray-100 text-left">
            <tr>
              <th class="py-2 px-4">Ảnh bìa</th>
              <th class="py-2 px-4">Tên sách</th>
              <th class="py-2 px-4">Tác giả</th>
              <th class="py-2 px-4">Ngày xuất bản</th>
              <th class="py-2 px-4">Thể loại</th>
              <th class="py-2 px-4">Giá</th>
              <th class="py-2 px-4">Kho</th>
              <th class="py-2 px-4">Hành động</th>
            </tr>
          </thead>
          <tbody id="book-table-body" class="bg-white">
            <!-- Render từ JS -->
          </tbody>
        </table>
      </div>
    </main>

    <!-- Modal Thêm sách -->
    <div
      id="book-modal"
      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded shadow-md w-full max-w-xl relative">
        <button
          onclick="closeAddModal()"
          class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-700"
        >
          &times;
        </button>
        <h2 class="text-xl font-semibold mb-4">Thêm sách</h2>
        <form
          id="book-form"
          class="grid grid-cols-1 gap-4"
          enctype="multipart/form-data"
        >
          <input
            name="title"
            required
            class="border rounded px-3 py-2"
            placeholder="Tên sách"
          />

          <input
            name="author"
            required
            class="border rounded px-3 py-2"
            placeholder="Tác giả"
          />

          <input
            name="published"
            required
            type="date"
            class="border rounded px-3 py-2"
            placeholder="Ngày xuất bản"
          />

          <input
            name="price"
            required
            type="number"
            class="border rounded px-3 py-2"
            placeholder="Giá"
          />

          <input
            name="stockQuantity"
            required
            type="number"
            class="border rounded px-3 py-2"
            placeholder="Số lượng trong kho"
          />

          <textarea
            name="description"
            class="border rounded px-3 py-2"
            placeholder="Mô tả"
          ></textarea>

          <input
            name="category"
            required
            class="border rounded px-3 py-2"
            placeholder="Thể loại"
          />

          <input
            name="coverImage"
            type="file"
            accept="image/*"
            class="border rounded px-3 py-2"
          />

          <button
            type="submit"
            class="bg-black text-white py-2 rounded hover:bg-gray-800"
          >
            Lưu
          </button>
        </form>
      </div>
    </div>

    <!-- Modal Sửa sách -->
    <div
      id="edit-book-modal"
      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded shadow-md w-full max-w-xl relative">
        <button
          onclick="closeEditModal()"
          class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-700"
        >
          &times;
        </button>
        <h2 class="text-xl font-semibold mb-4">Sửa sách</h2>
        <form id="edit-book-form" class="grid grid-cols-1 gap-4">
          <input
            id="edit-price"
            name="price"
            type="number"
            required
            class="border rounded px-3 py-2"
            placeholder="Giá"
          />
          <input
            id="edit-stock"
            name="stockQuantity"
            type="number"
            required
            class="border rounded px-3 py-2"
            placeholder="Số lượng"
          />
          <button
            type="submit"
            class="bg-black text-white py-2 rounded hover:bg-gray-800"
          >
            Lưu
          </button>
        </form>
      </div>
    </div>

    <script src="iconcart.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetchBooks();
      });

      // Fetch danh sách sách
      async function fetchBooks() {
        try {
          const res = await fetch("http://localhost:5178/Book/GetList");
          const books = await res.json();

          console.log(books);
          const tbody = document.getElementById("book-table-body");
          tbody.innerHTML = "";

          books.forEach((book) => {
            const tr = document.createElement("tr");
            console.log(book.id); // Kiểm tra giá trị book.id ở đây

            // Nếu book.coverImagePath có giá trị, sử dụng đường dẫn đầy đủ
            const imageUrl = book.coverImagePath
              ? `http://localhost:5178${book.coverImagePath}`
              : "/uploads/default.jpg"; // Ảnh mặc định

            tr.innerHTML = `
            <td class="py-2 px-4">
                <img src="${imageUrl}" alt="Cover" class="w-16 h-20 object-cover rounded" />
            </td>
            <td class="py-2 px-4">${book.title}</td>
            <td class="py-2 px-4">${book.author}</td>
            <td class="py-2 px-4">${book.releaseDate ?? "-"}</td>
            <td class="py-2 px-4">${book.category ?? "-"}</td>
            <td class="py-2 px-4">${book.price?.toLocaleString() ?? 0}đ</td>
            <td class="py-2 px-4">${book.stockQuantity ?? 0}</td>
            <td class="py-2 px-4 space-x-2">
                <button onclick="openEditModal(event)" data-id="${
                  book.bookId
                }">Edit</button>
                <button class="text-red-600 hover:underline" onclick="deleteBook(event)" data-id="${
                  book.bookId
                }">Xóa</button>
            </td>

            `;

            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error("Lỗi khi lấy danh sách sách:", error);
          alert("Không thể tải danh sách sách.");
        }
      }

      // Mở modal thêm sách
      function openAddModal() {
        document.getElementById("book-modal").classList.remove("hidden");
        document.getElementById("book-form").reset();
      }

      // Đóng modal thêm sách
      function closeAddModal() {
        document.getElementById("book-modal").classList.add("hidden");
      }

      document
        .getElementById("book-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);

          // Log dữ liệu FormData để kiểm tra
          for (let [key, value] of formData.entries()) {
            console.log(key, value); // Kiểm tra tất cả các cặp key-value trong FormData
          }

          try {
            const response = await fetch("http://localhost:5178/Book/AddBook", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();
            if (response.ok) {
              alert(result.message);
              closeAddModal();
              fetchBooks();
            } else {
              alert("Lỗi khi thêm sách.");
              console.log("Error:", result); // In ra lỗi chi tiết từ backend
            }
          } catch (error) {
            console.error("Lỗi khi thêm sách:", error);
            alert("Lỗi khi thêm sách.");
          }
        });

      // sửa sách//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // Mở modal sửa sách và điền thông tin sách vào form
      // Mở modal sửa sách và điền thông tin sách vào form
      async function openEditModal(e) {
        const bookId = e.target.closest("button").dataset.id;
        console.log(bookId); // Debug bookId

        if (!bookId) {
          console.error("Không tìm thấy bookId!");
          alert("Có lỗi khi lấy thông tin sách.");
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:5178/Book/GetBook/${bookId}`
          );
          const book = await res.json();

          if (!book) {
            throw new Error("Dữ liệu sách không hợp lệ");
          }

          document.getElementById("edit-price").value = book.price;
          document.getElementById("edit-stock").value = book.stockQuantity;
          document.getElementById("edit-book-form").dataset.bookId = bookId;

          document.getElementById("edit-book-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Lỗi khi lấy thông tin sách:", error);
          alert(`Không thể lấy thông tin sách. Chi tiết: ${error.message}`);
        }
      }

      // Đóng modal sửa sách
      function closeEditModal() {
        document.getElementById("edit-book-modal").classList.add("hidden");
      }

      // Xử lý gửi form sửa sách
      document
        .getElementById("edit-book-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const bookId = this.dataset.bookId; // Get bookId from the form's dataset

          // Tạo đối tượng từ FormData
          const updatedBook = {};
          formData.forEach((value, key) => {
            updatedBook[key] = value;
          });

          try {
            const response = await fetch(
              `http://localhost:5178/Book/UpdateBook/${bookId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json", // Đảm bảo Content-Type là application/json
                },
                body: JSON.stringify(updatedBook), // Chuyển đối tượng thành JSON
              }
            );

            const result = await response.json();
            if (response.ok) {
              alert(result.message);
              fetchBooks(); // Giả sử đây là hàm để tải lại danh sách sách
              closeEditModal(); // Đóng modal chỉnh sửa
            } else {
              alert("Lỗi khi sửa sách.");
              console.log("Error:", result);
            }
          } catch (error) {
            console.error("Lỗi khi sửa sách:", error);
            alert("Lỗi khi sửa sách.");
          }
        });

      async function deleteBook(event) {
        const bookId = event.target.dataset.id; // Lấy bookId từ thuộc tính data-id của nút

        if (confirm("Bạn có chắc chắn muốn xóa sách này?")) {
          try {
            const response = await fetch(
              `http://localhost:5178/Book/DeleteBook/${bookId}`,
              {
                method: "DELETE",
              }
            );

            const result = await response.json();
            if (response.ok) {
              alert(result.message);
              fetchBooks(); // Gọi lại API để cập nhật danh sách sách
            } else {
              alert("Lỗi khi xóa sách.");
              console.log("Error:", result);
            }
          } catch (error) {
            console.error("Lỗi khi xóa sách:", error);
            alert("Lỗi khi xóa sách.");
          }
        }
      }
    </script>
  </body>
</html>
