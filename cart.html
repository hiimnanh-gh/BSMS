<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gi·ªè h√†ng | Bookstore</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <script src="/search.js"></script>

    <script src="include-header.js"></script>

    <main class="px-6 py-10">
      <h1 class="text-3xl font-bold mb-6">Gi·ªè h√†ng c·ªßa b·∫°n</h1>
      <div id="cart-list" class="space-y-4"></div>

      <div class="mt-6 flex justify-between items-center border-t pt-4">
        <div>
          <label class="text-gray-700">
            <input type="checkbox" id="select-all" class="mr-2" /> Ch·ªçn t·∫•t c·∫£
          </label>
        </div>
        <button
          onclick="goToCheckout()"
          class="bg-black text-white px-6 py-2 rounded hover:bg-gray-800"
        >
          Thanh to√°n
        </button>
      </div>
    </main>

    <script>
      const API_URL = "http://localhost:5178/CartItem";

      window.addEventListener("load", function () {
        // X√≥a checkoutItems m·ªói khi trang cart.html ƒë∆∞·ª£c m·ªü l·∫°i
        sessionStorage.removeItem("checkoutItems");

        // Sau khi x√≥a, b·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c th·ª±c hi·ªán c√°c thao t√°c kh√°c nh∆∞ t·∫£i gi·ªè h√†ng
        fetchCart(); // Ho·∫∑c g·ªçi h√†m t·∫£i gi·ªè h√†ng c·ªßa b·∫°n
      });

      // üõí Load gi·ªè h√†ng
      async function fetchCart() {
        try {
          const cartID = sessionStorage.getItem("cartID");

          const response = await fetch(`${API_URL}/GetList?cartID=${cartID}`);

          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y gi·ªè h√†ng");

          const cartItems = await response.json();
          console.log("Gi·ªè h√†ng:", cartItems); // Debug ki·ªÉm tra
          console.log("Gi·ªè h√†ng:", cartItems);

          renderCart(cartItems);
        } catch (error) {
          console.error("L·ªói t·∫£i gi·ªè h√†ng:", error);
        }
      }

      // L·∫Øng nghe s·ª± ki·ªán "Ch·ªçn t·∫•t c·∫£"
      document
        .getElementById("select-all")
        .addEventListener("change", function () {
          // L·∫•y t·∫•t c·∫£ c√°c checkbox trong gi·ªè h√†ng
          const checkboxes = document.querySelectorAll(".cart-checkbox");

          // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa t·∫•t c·∫£ c√°c checkbox theo tr·∫°ng th√°i c·ªßa "Ch·ªçn t·∫•t c·∫£"
          checkboxes.forEach((checkbox) => {
            checkbox.checked = this.checked;
          });
        });

      // L∆∞u th√¥ng tin s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn v√†o sessionStorage
      function saveSelectedItemsToSession(cartItems) {
        if (!cartItems || cartItems.length === 0) {
          console.error("Gi·ªè h√†ng kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c kh√¥ng h·ª£p l·ªá.");
          return;
        }

        const selectedItems = [];
        // L·∫•y t·∫•t c·∫£ checkbox ƒë∆∞·ª£c ch·ªçn
        document
          .querySelectorAll(".cart-checkbox:checked")
          .forEach((checkbox) => {
            const bookId = checkbox.getAttribute("data-id");

            // Ki·ªÉm tra n·∫øu cartItems t·ªìn t·∫°i v√† c√≥ d·ªØ li·ªáu
            const cartItem = cartItems.find(
              (item) => String(item.bookId) === bookId
            );

            if (cartItem) {
              selectedItems.push({
                cartId: cartItem.cartId, // L∆∞u cartId
                bookId: cartItem.bookId, // L∆∞u bookId
                title: cartItem.bookTitle, // L∆∞u title
                price: cartItem.bookPrice, // L∆∞u price
                quantity: cartItem.quantity, // L∆∞u quantity
              });
            }
          });

        // Ki·ªÉm tra c√≥ item n√†o ƒë∆∞·ª£c ch·ªçn kh√¥ng
        if (selectedItems.length === 0) {
          alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.");
          return;
        }

        // L∆∞u v√†o sessionStorage
        sessionStorage.setItem("checkoutItems", JSON.stringify(selectedItems));
        console.log("Th√¥ng tin checkout ƒë√£ l∆∞u v√†o sessionStorage");
      }

      // Function chuy·ªÉn sang trang checkout
      function goToCheckout() {
        const cartID = sessionStorage.getItem("cartID");

        if (!cartID) {
          alert("Kh√¥ng t√¨m th·∫•y gi·ªè h√†ng.");
          return;
        }

        // G·ªçi h√†m l·∫•y gi·ªè h√†ng t·ª´ API v√† x·ª≠ l√Ω
        fetch(`${API_URL}/GetList?cartID=${cartID}`)
          .then((response) => response.json())
          .then((cartItems) => {
            if (!cartItems || cartItems.length === 0) {
              alert("Gi·ªè h√†ng tr·ªëng.");
              return;
            }

            // L∆∞u s·∫£n ph·∫©m ƒë√£ ch·ªçn v√†o sessionStorage
            saveSelectedItemsToSession(cartItems);

            // Chuy·ªÉn ƒë·∫øn trang checkout
            window.location.href = "checkout.html";
          })
          .catch((error) => {
            console.error("L·ªói khi l·∫•y gi·ªè h√†ng:", error);
            alert("C√≥ l·ªói x·∫£y ra khi l·∫•y gi·ªè h√†ng.");
          });
      }

      // üîÑ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
      async function updateCart(cartID, bookID, quantity) {
        if (quantity <= 0) {
          console.log(`X√≥a s·∫£n ph·∫©m: ${bookID}`); // Debug ki·ªÉm tra
          return removeCartItem(cartID, bookID);
        }

        try {
          const response = await fetch(
            `${API_URL}/Update?cartID=${cartID}&bookID=${bookID}&quantity=${quantity}`,
            {
              method: "PUT", // Ho·∫∑c "PUT" t√πy theo API backend
              headers: {
                "Content-Type": "application/json", // N·∫øu API y√™u c·∫ßu JSON
              },
              body: JSON.stringify({ cartID, bookID, quantity }),
            }
          );

          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi·ªè h√†ng");

          console.log(`C·∫≠p nh·∫≠t th√†nh c√¥ng: ${bookID} - S·ªë l∆∞·ª£ng: ${quantity}`);
          fetchCart();
        } catch (error) {
          console.error("L·ªói c·∫≠p nh·∫≠t gi·ªè h√†ng:", error);
        }
      }

      // ‚ùå X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
      async function removeCartItem(cartID, bookID) {
        try {
          const response = await fetch(
            `${API_URL}/Delete?cartID=${cartID}&bookID=${bookID}`,
            {
              method: "DELETE",
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`L·ªói x√≥a s·∫£n ph·∫©m: ${errorText}`);
          }

          console.log(`ƒê√£ x√≥a s·∫£n ph·∫©m ${bookID} kh·ªèi gi·ªè h√†ng`);
          fetchCart(); // Load l·∫°i gi·ªè h√†ng sau khi x√≥a
        } catch (error) {
          console.error("L·ªói x√≥a s·∫£n ph·∫©m:", error);
        }
      }

      // üé® Render gi·ªè h√†ng v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß
      function renderCart(cartItems) {
        console.log(cartItems);

        const container = document.getElementById("cart-list");
        container.innerHTML = "";

        if (!cartItems || cartItems.length === 0) {
          container.innerHTML = `<p class="text-gray-600">Gi·ªè h√†ng tr·ªëng.</p>`;
          return;
        }

        cartItems.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "cart-item flex items-center justify-between bg-white p-4 rounded shadow";
          div.setAttribute("data-bookid", item.bookId);

          div.innerHTML = `
            <div class="flex items-center gap-3">
              <input type="checkbox" class="cart-checkbox" data-id="${
                item.bookId
              }" />
              <div>
                <p class="font-semibold">${item.bookTitle}</p>
                <p class="text-sm text-gray-500">${item.bookPrice.toFixed(
                  2
                )} VND</p>
                <div class="flex items-center gap-2 mt-2">
                  <button onclick="updateCart('${item.cartId}', '${
            item.bookId
          }', ${item.quantity - 1})" class="px-2 border rounded">-</button>
                  <span class="quantity">${item.quantity}</span>
                  <button onclick="updateCart('${item.cartId}', '${
            item.bookId
          }', ${item.quantity + 1})" class="px-2 border rounded">+</button>
                </div>
              </div>
            </div>
            <button onclick="removeCartItem('${item.cartId}', '${
            item.bookId
          }')" class="text-red-500 hover:underline text-sm">
              X√≥a
            </button>
          `;

          container.appendChild(div);
        });
      }

      // L·∫•y gi·ªè h√†ng v√† g√°n event cho n√∫t thanh to√°n
      const checkoutButton = document.querySelector(
        'button[onclick="goToCheckout()"]'
      );
      checkoutButton.addEventListener("click", () => {
        saveSelectedItemsToSession(cartItems);
        // Chuy·ªÉn sang trang thanh to√°n
        window.location.href = "checkout.html";
      });

      // üîÑ Load gi·ªè h√†ng khi v√†o trang
      fetchCart();
    </script>
  </body>
</html>
