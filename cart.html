<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gi·ªè h√†ng | Bookstore</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <script src="include-header.js"></script>

    <main class="px-6 py-10">
      <h1 class="text-3xl font-bold mb-6">Gi·ªè h√†ng c·ªßa b·∫°n</h1>
      <div id="cart-list" class="space-y-4"></div>

      <div class="mt-6 flex justify-between items-center border-t pt-4">
        <div>
          <label class="text-gray-700">
            <input type="checkbox" id="select-all" class="mr-2" /> Ch·ªçn t·∫•t c·∫£
          </label>
        </div>
        <button
          onclick="goToCheckout()"
          class="bg-black text-white px-6 py-2 rounded hover:bg-gray-800"
        >
          Thanh to√°n
        </button>
      </div>
    </main>

    <script>
      const API_URL = "http://localhost:5178/CartItem";

      // üõí Load gi·ªè h√†ng
      async function fetchCart() {
        try {
          const cartID = sessionStorage.getItem("cartID");

          const response = await fetch(`${API_URL}/GetList?cartID=${cartID}`);

          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y gi·ªè h√†ng");

          const cartItems = await response.json();
          console.log("Gi·ªè h√†ng:", cartItems); // Debug ki·ªÉm tra
          console.log("Gi·ªè h√†ng:", cartItems);

          renderCart(cartItems);
        } catch (error) {
          console.error("L·ªói t·∫£i gi·ªè h√†ng:", error);
        }
      }

      // üîÑ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
      async function updateCart(cartID, bookID, quantity) {
        if (quantity <= 0) {
          console.log(`X√≥a s·∫£n ph·∫©m: ${bookID}`); // Debug ki·ªÉm tra
          return removeCartItem(cartID, bookID);
        }

        try {
          const response = await fetch(
            `${API_URL}/Update?cartID=${cartID}&bookID=${bookID}&quantity=${quantity}`,
            {
              method: "PUT", // Ho·∫∑c "PUT" t√πy theo API backend
              headers: {
                "Content-Type": "application/json", // N·∫øu API y√™u c·∫ßu JSON
              },
              body: JSON.stringify({ cartID, bookID, quantity }),
            }
          );

          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi·ªè h√†ng");

          console.log(`C·∫≠p nh·∫≠t th√†nh c√¥ng: ${bookID} - S·ªë l∆∞·ª£ng: ${quantity}`);
          fetchCart();
        } catch (error) {
          console.error("L·ªói c·∫≠p nh·∫≠t gi·ªè h√†ng:", error);
        }
      }

      // ‚ùå X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
      async function removeCartItem(cartID, bookID) {
        try {
          const response = await fetch(
            `${API_URL}/Delete?cartID=${cartID}&bookID=${bookID}`,
            {
              method: "DELETE",
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`L·ªói x√≥a s·∫£n ph·∫©m: ${errorText}`);
          }

          console.log(`ƒê√£ x√≥a s·∫£n ph·∫©m ${bookID} kh·ªèi gi·ªè h√†ng`);
          fetchCart(); // Load l·∫°i gi·ªè h√†ng sau khi x√≥a
        } catch (error) {
          console.error("L·ªói x√≥a s·∫£n ph·∫©m:", error);
        }
      }

      // üé® Render gi·ªè h√†ng v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß
      function renderCart(cartItems) {
        console.log(cartItems);

        const container = document.getElementById("cart-list");
        container.innerHTML = "";

        if (cartItems == null || cartItems.length === 0) {
          container.innerHTML = `<p class="text-gray-600">Gi·ªè h√†ng tr·ªëng.</p>`;
          return;
        }

        cartItems.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "flex items-center justify-between bg-white p-4 rounded shadow";

          div.innerHTML = `
        <div class="flex items-center gap-3">
            <input type="checkbox" class="cart-checkbox" data-id="${
              item.bookId
            }" />
            <div>
                <p class="font-semibold">${item.bookTitle}</p>
                <p class="text-sm text-gray-500">${item.bookPrice.toFixed(
                  2
                )} VND</p>
                <div class="flex items-center gap-2 mt-2">
                    <button onclick="updateCart('${item.cartId}', '${
            item.bookId
          }', ${item.quantity - 1})" class="px-2 border rounded">-</button>
                    <span>${item.quantity}</span>
                    <button onclick="updateCart('${item.cartId}', '${
            item.bookId
          }', ${item.quantity + 1})" class="px-2 border rounded">+</button>
                </div>
            </div>
        </div>
        <button onclick="removeCartItem('${item.cartId}', '${
            item.bookId
          }')" class="text-red-500 hover:underline text-sm">X√≥a</button>
    `;

          container.appendChild(div);
        });
      }

      // üîÑ Load gi·ªè h√†ng khi v√†o trang
      fetchCart();
    </script>
  </body>
</html>
