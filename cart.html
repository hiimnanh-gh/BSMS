<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ hàng | Bookstore</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <script src="include-header.js"></script>

    <main class="px-6 py-10">
      <h1 class="text-3xl font-bold mb-6">Giỏ hàng của bạn</h1>
      <div id="cart-list" class="space-y-4"></div>

      <div class="mt-6 flex justify-between items-center border-t pt-4">
        <div>
          <label class="text-gray-700">
            <input type="checkbox" id="select-all" class="mr-2" /> Chọn tất cả
          </label>
        </div>
        <button
          onclick="goToCheckout()"
          class="bg-black text-white px-6 py-2 rounded hover:bg-gray-800"
        >
          Thanh toán
        </button>
      </div>
    </main>

    <script>
      const API_URL = "http://localhost:5178/CartItem";

      async function fetchCart() {
        try {
          const response = await fetch(`${API_URL}/GetList`);
          if (!response.ok) throw new Error("Không thể lấy giỏ hàng");
          const cartItems = await response.json();
          renderCart(cartItems);
        } catch (error) {
          console.error("Lỗi tải giỏ hàng:", error);
        }
      }

      async function addToCart(cartID, bookID, quantity = 1) {
        try {
          const response = await fetch(
            `${API_URL}/Insert?cartID=${cartID}&bookID=${bookID}&quantity=${quantity}`,
            {
              method: "POST",
            }
          );
          if (!response.ok) throw new Error("Không thể thêm vào giỏ hàng");
          alert("Đã thêm vào giỏ hàng!");
          fetchCart();
        } catch (error) {
          console.error("Lỗi thêm giỏ hàng:", error);
        }
      }

      async function updateCart(cartID, bookID, quantity) {
        if (quantity <= 0) return removeCartItem(cartID, bookID);
        try {
          const response = await fetch(
            `${API_URL}/Update?cartID=${cartID}&bookID=${bookID}&quantity=${quantity}`,
            {
              method: "POST",
            }
          );
          if (!response.ok) throw new Error("Không thể cập nhật giỏ hàng");
          fetchCart();
        } catch (error) {
          console.error("Lỗi cập nhật giỏ hàng:", error);
        }
      }

      async function removeCartItem(cartID, bookID) {
        try {
          const response = await fetch(
            `${API_URL}/Delete?cartID=${cartID}&bookID=${bookID}`,
            {
              method: "POST",
            }
          );
          if (!response.ok) throw new Error("Không thể xóa sản phẩm");
          fetchCart();
        } catch (error) {
          console.error("Lỗi xóa sản phẩm:", error);
        }
      }

      function renderCart(cartItems) {
        const container = document.getElementById("cart-list");
        container.innerHTML = "";

        if (cartItems.length === 0) {
          container.innerHTML = `<p class="text-gray-600">Giỏ hàng trống.</p>`;
          return;
        }

        cartItems.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "flex items-center justify-between bg-white p-4 rounded shadow";
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <input type="checkbox" class="cart-checkbox" data-id="${
                item.bookId
              }" />
              <div>
                <p class="font-semibold">${item.bookId}</p>
                <div class="flex items-center gap-2 mt-2">
                  <button onclick="updateCart('${item.cartId}', '${
            item.bookId
          }', ${item.quantity - 1})" class="px-2 border rounded">-</button>
                  <span>${item.quantity}</span>
                  <button onclick="updateCart('${item.cartId}', '${
            item.bookId
          }', ${item.quantity + 1})" class="px-2 border rounded">+</button>
                </div>
              </div>
            </div>
            <button onclick="removeCartItem('${item.cartId}', '${
            item.bookId
          }')" class="text-red-500 hover:underline text-sm">Xóa</button>
          `;
          container.appendChild(div);
        });
      }

      fetchCart();
    </script>
  </body>
</html>
