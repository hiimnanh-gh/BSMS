<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sách | Bookstore</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-50 text-gray-800 font-sans">
    <script src="/include-header.js"></script>

    <!-- BOOK LIST -->
    <main class="px-6 py-10">
      <h1 class="text-3xl font-bold mb-6">Tất cả sách</h1>
      <div
        id="book-grid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
        <!-- Sách sẽ được load từ API -->
      </div>
    </main>

    <!-- MODAL cảnh báo chưa đăng nhập -->
    <div
      id="login-warning-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white p-6 rounded shadow-lg text-center w-[320px]">
        <p class="text-lg font-semibold mb-4">
          Bạn cần đăng nhập để sử dụng tính năng này
        </p>
        <div class="flex justify-between gap-4">
          <a
            href="login.html"
            class="flex-1 bg-black text-white py-2 rounded hover:bg-gray-800"
            >Đăng nhập</a
          >
          <a
            href="register-modal.html"
            class="flex-1 border border-black text-black py-2 rounded hover:bg-gray-100"
            >Đăng ký</a
          >
        </div>
        <button
          onclick="closeLoginWarning()"
          class="text-sm text-gray-500 mt-4 hover:underline"
        >
          Đóng
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetchBooks();
      });

      // Kiểm tra người dùng đã đăng nhập chưa
      function isUserLoggedIn() {
        const userId = sessionStorage.getItem("UserID"); // Đảm bảo sử dụng "UserID" với viết hoa đúng
        return userId !== null;
      }

      // Gắn sự kiện cho nút "Thêm vào giỏ hàng"
      document.querySelectorAll(".add-to-cart").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const bookID = e.target.dataset.id;
          const quantity = 1; // Số lượng mặc định là 1

          try {
            let cartID = sessionStorage.getItem("cartID");
            console.log("cartID:", cartID); // Kiểm tra giá trị cartID

            if (!cartID) return;

            // Gọi API để thêm sản phẩm vào giỏ hàng
            const response = await fetch(
              "http://localhost:5178/ShoppingCart/AddProductToCart",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cartID, bookID, quantity }),
              }
            );

            if (!response.ok) {
              throw new Error("Không thể thêm sản phẩm vào giỏ hàng");
            }

            alert("Sản phẩm đã được thêm vào giỏ hàng!");
          } catch (error) {
            console.error("Lỗi khi xử lý giỏ hàng:", error);
            alert("Lỗi khi thêm sản phẩm vào giỏ hàng");
          }
        });
      });

      // Lấy danh sách sách từ API
      async function fetchBooks() {
        try {
          const response = await fetch("http://localhost:5178/Book/GetList");
          if (!response.ok) throw new Error("Không thể tải danh sách sách.");
          const books = await response.json();
          renderBooks(books);
        } catch (error) {
          console.error("Lỗi API:", error);
          document.getElementById(
            "book-grid"
          ).innerHTML = `<p class="text-red-500">Lỗi tải sách. Vui lòng thử lại sau.</p>`;
        }
      }

      // Render danh sách sách
      function renderBooks(books) {
        const container = document.getElementById("book-grid");
        container.innerHTML = "";

        if (!books || books.length === 0) {
          container.innerHTML = `<p class="text-gray-500">Không có sách nào.</p>`;
          return;
        }

        books.forEach((book) => {
          if (!book.bookId) return;

          const imageUrl = book.coverImagePath
            ? `http://localhost:5178${book.coverImagePath}`
            : "/uploads/default.jpg"; // Ảnh mặc định

          const div = document.createElement("div");
          div.className = "bg-white rounded shadow p-4";
          div.innerHTML = ` 
          <img src="${imageUrl}" onerror="this.src='/uploads/default.jpg';" alt="${
            book.title
          }" class="w-full h-60 object-cover rounded" />
          <h3 class="mt-3 text-lg font-semibold">${book.title}</h3>
          <p class="text-gray-600">Thể loại: ${book.category || "Không rõ"}</p>
          <p class="text-gray-800 font-bold mt-1">Giá: ${Number(
            book.price || 0
          ).toLocaleString("vi-VN")}đ</p>
          <button class="add-to-cart mt-3 w-full bg-black text-white py-2 px-4 rounded hover:bg-gray-800 transition" data-id="${
            book.bookId
          }">
            Thêm vào giỏ hàng
          </button>
        `;
          container.appendChild(div);
        });

        attachCartEvents();
      }

      // Gắn sự kiện cho các nút "Thêm vào giỏ hàng"
      function attachCartEvents() {
        document.querySelectorAll(".add-to-cart").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const BookID = e.target.dataset.id;

            if (!BookID) return;

            if (!isUserLoggedIn()) {
              console.warn("⚠️ Chưa đăng nhập!");
              document
                .getElementById("login-warning-modal")
                .classList.remove("hidden");
              return;
            }

            try {
              // Lấy cartID từ sessionStorage
              const cartID = sessionStorage.getItem("cartID");

              const existingCartItem = await checkCartItem(cartID, BookID);
              console.log("existingCartItem:", existingCartItem); // Kiểm tra giá trị existingCartItem

              if (existingCartItem.message == "Sản phẩm đã có trong giỏ hàng") {
                await updateCartItem(
                  existingCartItem.cartID,
                  existingCartItem.quantity + 1
                );
              } else {
                let response = addToCart(cartID, BookID, 1);
                console.log("✅ Thêm vào giỏ hàng thành công:", response);
              }

              alert(`✅ Đã thêm vào giỏ hàng!`);
            } catch (error) {
              console.error("Lỗi khi xử lý giỏ hàng:", error);
            }
          });
        });
      }

      // Kiểm tra xem sách đã có trong giỏ hàng chưa
      async function checkCartItem(cartID, bookID) {
        console.log("cartID:", cartID); // Kiểm tra giá trị cartID
        console.log("bookID:", bookID); // Kiểm tra giá trị bookID

        // Lấy cartID từ sessionStorage
        cartID = sessionStorage.getItem("cartID");
        try {
          let response = await fetch(
            `http://localhost:5178/CartItem/Check?cartID=${cartID}&bookID=${bookID}`
          );
          if (!response.ok) {
            throw new Error("Không tìm thấy sản phẩm trong giỏ hàng");
          }
          let data = await response.json();
          console.log("Kết quả:", data);
          return data; // Trả về dữ liệu sản phẩm trong giỏ hàng
        } catch (error) {
          console.error("Lỗi khi xử lý giỏ hàng:", error);
        }
      }

      // Thêm sách vào giỏ hàng
      async function addToCart(cartID, bookID, quantity) {
        try {
          let response = await fetch(
            `http://localhost:5178/CartItem/Insert?cartID=${cartID}&bookID=${bookID}&quantity=${quantity}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            }
          );

          let data = await response.json();
          if (!response.ok)
            throw new Error(data.message || "Lỗi khi thêm vào giỏ");

          return data; // Trả về dữ liệu thêm vào giỏ hàng
        } catch (error) {
          console.error("❌ Lỗi khi thêm sách vào giỏ:", error);
        }
      }

      // Cập nhật số lượng giỏ hàng
      async function updateCartItem(bookID, newQuantity) {
        let cartID = sessionStorage.getItem("cartID");

        if (!cartID) {
          console.error("⚠️ Lỗi: Không tìm thấy cartID");
          return;
        }

        try {
          let response = await fetch(
            `http://localhost:5178/CartItem/Update?cartID=${cartID}&bookID=${bookID}&quantity=${newQuantity}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
            }
          );

          let data = await response.json();
          if (!response.ok) throw new Error(data.message || "Lỗi khi cập nhật");

          console.log("✅ Cập nhật giỏ hàng thành công:", data);
        } catch (error) {
          console.error("❌ Lỗi khi cập nhật giỏ hàng:", error);
        }
      }

      // Đóng modal cảnh báo chưa đăng nhập
      function closeLoginWarning() {
        document.getElementById("login-warning-modal").classList.add("hidden");
      }
    </script>
  </body>
</html>
<div></div>
