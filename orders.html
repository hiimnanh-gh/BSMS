<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>L·ªãch s·ª≠ ƒë∆°n h√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-6">
    <script src="iconcart.js"></script>
    <script src="include-header.js"></script>

    <div class="max-w-3xl mx-auto">
      <h1 class="text-2xl font-bold mb-4">L·ªãch s·ª≠ ƒë∆°n h√†ng</h1>
      <div id="order-list" class="space-y-4"></div>
    </div>

    <script>
      const userId = sessionStorage.getItem("UserID");

      document.addEventListener("DOMContentLoaded", () => {
        fetchOrders();
      });

      async function fetchOrders() {
        try {
          const res = await fetch(
            `http://localhost:5178/Order/GetOrdersByUserId/${userId}`
          );
          const data = await res.json();

          const container = document.getElementById("order-list");
          if (!data || data.length === 0) {
            container.innerHTML = `<p class="text-gray-600">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>`;
            return;
          }

          data.forEach((order, index) => {
            const itemsHtml =
              order.items
                ?.map((item) => {
                  const name = item.bookTitle || item.productName || "S·∫£n ph·∫©m";
                  const price = item.price || 0;
                  const quantity = item.quantity || 0;
                  const total = price * quantity;

                  return `
                  <li class="flex justify-between text-sm text-gray-700">
                    <span>${name} (x${quantity})</span>
                    <span>${total.toLocaleString()}ƒë</span>
                  </li>`;
                })
                .join("") ??
              "<li class='text-sm text-gray-500'>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</li>";

            const html = `
              <div class="border p-4 rounded-lg shadow-sm bg-white">
                <h2 class="text-xl font-semibold">ƒê∆°n h√†ng #${index + 1}</h2>
                <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${order.customerName}</p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.customerAddress}</p>
                <p><strong>T·ªïng ti·ªÅn:</strong> ${
                  order.totalAmount
                    ? order.totalAmount.toLocaleString() + "ƒë"
                    : "0ƒë"
                }</p>
                <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${
                  order.paymentMethod ?? "Thanh to√°n khi nh·∫≠n h√†ng"
                }</p>

                <div class="flex gap-4 mt-2">
                  <button class="text-blue-600 underline" onclick="toggleDetails('details-${index}')">
                    Xem chi ti·∫øt
                  </button>
                  <button class="text-green-600 underline" onclick="toggleMap('${order.customerAddress}', 'map-${index}')">
                    üìç Theo d√µi ƒë∆°n h√†ng
                  </button>
                </div>

                <ul id="details-${index}" class="hidden mt-2 ml-4 list-disc">
                  ${itemsHtml}
                </ul>
                <div id="map-${index}" class="mt-3 h-[300px] rounded hidden"></div>
              </div>
            `;
            container.innerHTML += html;
          });
        } catch (err) {
          console.error("L·ªói khi l·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng:", err);
          alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng.");
        }
      }

      function toggleDetails(id) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("hidden");
      }

      function trackOrder(orderId) {
        sessionStorage.setItem("trackingOrderId", orderId);
        window.location.href = "order-tracking.html";
      }

      function toggleMap(address, mapId) {
        const mapDiv = document.getElementById(mapId);

        if (!mapDiv.classList.contains("hidden")) {
          mapDiv.classList.add("hidden");
          mapDiv.innerHTML = ""; // X√≥a n·ªôi dung b·∫£n ƒë·ªì khi ·∫©n
          return;
        }

        mapDiv.classList.remove("hidden");

        // D√πng API free ƒë·ªÉ geocode ƒë·ªãa ch·ªâ
        fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            address
          )}`
        )
          .then((res) => res.json())
          .then((data) => {
            if (!data || data.length === 0) {
              mapDiv.innerHTML = "<p class='text-red-500'>Kh√¥ng t√¨m th·∫•y v·ªã tr√≠.</p>";
              return;
            }

            const { lat, lon } = data[0];

            // X√≥a n·ªôi dung c≈© tr∆∞·ªõc khi t·∫°o b·∫£n ƒë·ªì m·ªõi
            mapDiv.innerHTML = "";

            const map = L.map(mapId).setView([lat, lon], 16);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
            }).addTo(map);

            L.marker([lat, lon]).addTo(map).bindPopup("V·ªã tr√≠ giao h√†ng").openPopup();
          })
          .catch((err) => {
            console.error("L·ªói geocoding:", err);
            mapDiv.innerHTML = "<p class='text-red-500'>L·ªói khi t·∫£i b·∫£n ƒë·ªì.</p>";
          });
      }
    </script>
      <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans">
    <div class="max-w-3xl mx-auto p-6">
      <h1 class="text-2xl font-bold mb-4">üìç Theo d√µi ƒë∆°n h√†ng</h1>
      <div class="space-y-4" id="tracking-container"></div>
    </div>
    <srcipt src="order-tracking.js"></script>
  </body>
</html>
