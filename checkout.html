<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh toán | Bookstore</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans">
    <div class="max-w-4xl mx-auto p-6 bg-white mt-8 rounded shadow">
      <h1 class="text-3xl font-bold mb-6">Xác nhận đơn hàng</h1>

      <!-- Danh sách sách -->
      <div id="checkout-items" class="space-y-4 mb-6"></div>

      <!-- Tổng tiền -->
      <div class="text-right text-xl font-semibold mb-6">
        Tổng cộng: <span id="total-amount">0đ</span>
      </div>

      <!-- Thông tin người nhận -->
      <div class="mb-6 space-y-4">
        <input
          type="text"
          id="customer-name"
          placeholder="Họ tên người nhận"
          class="w-full border px-4 py-2 rounded"
          required
        />
        <input
          type="text"
          id="customer-phone"
          placeholder="Số điện thoại"
          class="w-full border px-4 py-2 rounded"
          required
        />
        <input
          type="text"
          id="customer-address"
          placeholder="Địa chỉ giao hàng"
          class="w-full border px-4 py-2 rounded"
          required
        />
      </div>

      <!-- Mã giảm giá -->
      <div class="flex gap-4 mb-6">
        <select id="discount-code" class="border px-4 py-2 rounded w-full">
          <option value="">-- Chọn mã giảm giá --</option>
          <option value="LOVEBOOK">LOVEBOOK - Giảm 15.000đ</option>
          <option value="USAGI">USAGI - Giảm 15.000đ</option>
          <option value="CHIIKAWA">CHIIKAWA - Giảm 15.000đ</option>
          <option value="HACHIWARE">HACHIWARE - Giảm 15.000đ</option>
        </select>
        <button
          onclick="applyDiscount()"
          class="bg-black text-white px-4 py-2 rounded"
        >
          Áp dụng
        </button>
      </div>

      <!-- Phương thức thanh toán -->
      <div class="mb-6">
        <label class="block mb-2 font-medium"
          >Chọn phương thức thanh toán:</label
        >
        <div class="space-y-2" id="payment-methods">
          <label
            ><input type="radio" name="payment" value="cod" checked /> Thanh
            toán khi nhận hàng</label
          ><br />
          <label
            ><input type="radio" name="payment" value="credit" /> Thẻ tín
            dụng</label
          ><br />
          <label
            ><input type="radio" name="payment" value="bank" /> Thẻ ngân
            hàng</label
          ><br />
          <label
            ><input type="radio" name="payment" value="transfer" /> Chuyển
            khoản</label
          >
        </div>
      </div>

      <!-- Thông tin thanh toán bổ sung -->
      <div id="payment-details" class="mb-6 hidden">
        <!-- nội dung động -->
      </div>

      <!-- Nút xác nhận và quay lại-->
      <div>
        <span>
          <button
            onclick="goBack()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded text-lg font-medium"
          >
            ⬅ Quay lại
          </button>
        </span>
        <span class="float-right">
          <button
            onclick="submitOrder()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded text-lg font-medium"
          >
            Đặt hàng
          </button>
        </span>
      </div>
    </div>

    <script>
      document.querySelectorAll('input[name="payment"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          const selectedPaymentMethod = document.querySelector(
            'input[name="payment"]:checked'
          ).value;
          const paymentDetailsEl = document.getElementById("payment-details");
          paymentDetailsEl.classList.remove("hidden");

          if (selectedPaymentMethod === "credit") {
            paymentDetailsEl.innerHTML = `
                <input type="text" id="card-number" placeholder="Số thẻ tín dụng" class="w-full border px-4 py-2 rounded mb-4" required />
                <input type="text" id="card-expiry" placeholder="Ngày hết hạn" class="w-full border px-4 py-2 rounded mb-4" required />
                <input type="text" id="card-cvc" placeholder="CVC" class="w-full border px-4 py-2 rounded mb-4" required />
            `;
          } else if (selectedPaymentMethod === "bank") {
            paymentDetailsEl.innerHTML = `
                <input type="text" id="bank-account" placeholder="Số tài khoản ngân hàng" class="w-full border px-4 py-2 rounded mb-4" required />
                <input type="text" id="bank-name" placeholder="Tên ngân hàng" class="w-full border px-4 py-2 rounded mb-4" required />
            `;
          } else if (selectedPaymentMethod === "transfer") {
            paymentDetailsEl.innerHTML = `
                <input type="text" id="transfer-account" placeholder="Số tài khoản chuyển khoản" class="w-full border px-4 py-2 rounded mb-4" required />
                <input type="text" id="transfer-bank" placeholder="Ngân hàng chuyển khoản" class="w-full border px-4 py-2 rounded mb-4" required />
            `;
          } else {
            paymentDetailsEl.innerHTML = ""; // Nếu chọn phương thức khác, ẩn thông tin thanh toán bổ sung
          }
        });
      });

      const userId = sessionStorage.getItem("UserID");
      console.log("UserId từ sessionStorage: ", userId);

      document.addEventListener("DOMContentLoaded", function () {
        loadCheckoutItems();
      });

      function loadCheckoutItems() {
        const checkoutItems =
          JSON.parse(sessionStorage.getItem("checkoutItems")) || [];
        console.log("Checkout Items:", checkoutItems); // Debug

        const container = document.getElementById("checkout-items");
        const totalAmountEl = document.getElementById("total-amount");
        container.innerHTML = "";

        if (checkoutItems.length === 0) {
          container.innerHTML = `<p class="text-gray-600">Không có sản phẩm nào trong đơn hàng.</p>`;
          totalAmountEl.textContent = "0đ";
          return;
        }

        let totalAmount = 0;

        checkoutItems.forEach((item) => {
          if (!item.title || !item.price || !item.quantity) {
            console.error("Lỗi dữ liệu sản phẩm:", item);
            return;
          }

          const itemTotal = item.price * item.quantity;
          totalAmount += itemTotal;

          const div = document.createElement("div");
          div.className =
            "flex justify-between items-center bg-gray-100 p-4 rounded";
          div.innerHTML = `
        <div>
          <p class="font-semibold">${item.title}</p>
          <p class="text-sm text-gray-500">${item.price.toFixed(2)} VND x ${
            item.quantity
          }</p>
        </div>
        <p class="text-lg font-semibold">${itemTotal.toFixed(2)} VND</p>
      `;

          container.appendChild(div);
        });

        totalAmountEl.textContent = `${totalAmount.toFixed(2)} VND`;
      }

      // Áp dụng mã giảm giá
      function applyDiscount() {
        const discountCode = document.getElementById("discount-code").value;
        const totalAmountEl = document.getElementById("total-amount");
        let totalAmount = parseFloat(
          totalAmountEl.innerText.replace(" VND", "")
        );

        const discountValues = {
          LOVEBOOK: 15000,
          USAGI: 15000,
          CHIIKAWA: 15000,
          HACHIWARE: 15000,
        };

        if (discountValues[discountCode]) {
          totalAmount -= discountValues[discountCode];
          totalAmountEl.innerText = `${Math.max(totalAmount, 0).toFixed(
            2
          )} VND`;
          alert("Mã giảm giá áp dụng thành công!");
        } else {
          alert("Mã giảm giá không hợp lệ!");
        }
      }

      // Gửi đơn hàng
      function submitOrder() {
        const name = document.getElementById("customer-name").value.trim();
        const phone = document.getElementById("customer-phone").value.trim();
        const address = document
          .getElementById("customer-address")
          .value.trim();
        const paymentMethod = document.querySelector(
          "input[name='payment']:checked"
        ).value;
        const checkoutItems =
          JSON.parse(sessionStorage.getItem("checkoutItems")) || [];

        if (!name || !phone || !address) {
          alert("Vui lòng điền đầy đủ thông tin nhận hàng.");
          return;
        }

        if (checkoutItems.length === 0) {
          alert("Không có sản phẩm nào để đặt hàng.");
          return;
        }

        // Lấy thông tin thanh toán bổ sung
        let paymentDetails = {};
        if (paymentMethod === "credit") {
          paymentDetails = {
            cardNumber: document.getElementById("card-number").value,
            cardExpiry: document.getElementById("card-expiry").value,
            cardCVC: document.getElementById("card-cvc").value,
          };
        } else if (paymentMethod === "bank") {
          paymentDetails = {
            bankAccount: document.getElementById("bank-account").value,
            bankName: document.getElementById("bank-name").value,
          };
        } else if (paymentMethod === "transfer") {
          paymentDetails = {
            transferAccount: document.getElementById("transfer-account").value,
            transferBank: document.getElementById("transfer-bank").value,
          };
        }

        const orderData = {
          userId: userId, // UserId của người dùng
          address: address, // Địa chỉ
          paymentMethod: paymentMethod, // Phương thức thanh toán
          paymentDetails: paymentDetails, // Thông tin bổ sung
          orderItems: checkoutItems, // Danh sách sản phẩm trong đơn hàng
        };

        console.log("Đơn hàng:", orderData);

        // Gọi hàm placeOrder để xử lý việc gửi đơn hàng
        placeOrder(orderData);
      }

      async function placeOrder(orderData) {
        // Kiểm tra orderData trước khi lấy checkoutItems
        const checkoutItems = orderData.OrderItems;

        // Kiểm tra xem checkoutItems có dữ liệu hợp lệ không
        if (!Array.isArray(checkoutItems) || checkoutItems.length === 0) {
          alert("Không có sản phẩm trong đơn hàng.");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:5178/Order/CreateOrder",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(orderData),
            }
          );

          const data = await response.text(); // Lấy dữ liệu dưới dạng text để kiểm tra nội dung
          console.log("Order response:", data); // In nội dung phản hồi để xem chi tiết

          let parsedData = {};
          try {
            parsedData = JSON.parse(data);
          } catch (error) {
            console.error("Lỗi phân tích JSON:", error);
          }

          if (response.ok) {
            alert("Đặt hàng thành công");
            const orderID = parsedData.orderId; // Lấy orderId từ response
            await insertOrderItems(orderID, checkoutItems); // Gọi insertOrderItems với checkoutItems
          } else {
            alert(`Lỗi: ${parsedData.message || "Đã có lỗi xảy ra."}`);
          }
        } catch (error) {
          console.error("Lỗi thanh toán:", error);
          alert("Đã xảy ra lỗi khi thanh toán.");
        }
      }

      async function insertOrderItems(orderID, checkoutItems) {
        // Kiểm tra checkoutItems có phải là mảng không và có phần tử hay không
        if (!Array.isArray(checkoutItems) || checkoutItems.length === 0) {
          console.error("Không có sản phẩm trong đơn hàng.");
          alert("Không có sản phẩm trong đơn hàng.");
          return;
        }

        const orderItemData = checkoutItems.map((item) => ({
          OrderId: orderID,
          BookId: item.bookId,
          Quantity: item.quantity,
        }));

        try {
          const response = await fetch(
            "http://localhost:5178/orderitem/Insert", // Đảm bảo đây là URL chính xác
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(orderItemData),
            }
          );

          const data = await response.json();
          console.log("OrderItems response:", data); // Để kiểm tra phản hồi từ API

          if (response.ok) {
            alert("Mục đơn hàng đã được thêm thành công");
          } else {
            alert(`Lỗi: ${data.message}`);
          }
        } catch (error) {
          console.error("Lỗi thêm mục đơn hàng:", error);
          alert("Đã xảy ra lỗi khi thêm mục đơn hàng.");
        }
      }
      function goBack() {
        // Xóa giỏ hàng khỏi sessionStorage khi quay lại
        sessionStorage.removeItem("checkoutItems");

        // Chuyển hướng lại trang giỏ hàng
        window.location.href = "cart.html"; // Hoặc quay lại trang giỏ hàng của bạn
      }
    </script>
  </body>
</html>
